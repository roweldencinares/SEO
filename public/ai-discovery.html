<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Discovery & Visibility - SEO Dashboard</title>
    <link rel="stylesheet" href="/sidebar.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { color: #333; font-size: 1.8rem; font-weight: 700; }
        .subtitle { color: #666; font-size: 0.95rem; }
        .scan-btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .scan-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .scan-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .platform-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .platform-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #e0e0e0; }
        .platform-card.high { border-left-color: #28a745; }
        .platform-card.medium { border-left-color: #ffc107; }
        .platform-card.low { border-left-color: #dc3545; }
        .platform-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .platform-name { font-size: 1.1rem; font-weight: 700; color: #333; }
        .platform-score { font-size: 1.4rem; font-weight: 700; }
        .platform-card.high .platform-score { color: #28a745; }
        .platform-card.medium .platform-score { color: #ffc107; }
        .platform-card.low .platform-score { color: #dc3545; }
        .platform-detail { font-size: 0.85rem; color: #666; margin-bottom: 6px; }
        .platform-bar { height: 6px; background: #e9ecef; border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .platform-bar-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h2 { font-size: 1.2rem; color: #333; margin-bottom: 15px; }
        .chart-container { position: relative; height: 300px; }
        .query-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .query-card { border: 1px solid #e9ecef; border-radius: 10px; padding: 18px; }
        .query-text { font-weight: 600; color: #333; margin-bottom: 8px; font-size: 0.95rem; }
        .query-results { font-size: 0.85rem; color: #666; }
        .query-results .mentioned { color: #28a745; font-weight: 500; }
        .query-results .not-mentioned { color: #dc3545; font-weight: 500; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; border-bottom: 2px solid #e9ecef; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; color: #333; }
        tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-yes { background: #d4edda; color: #155724; }
        .badge-no { background: #f8d7da; color: #721c24; }
        .badge-partial { background: #fff3cd; color: #856404; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .mini-stat { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .mini-stat .value { font-size: 1.6rem; font-weight: 700; }
        .mini-stat .label { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .loading { text-align: center; padding: 30px; color: #888; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>AI Discovery & Visibility</h1>
                <p class="subtitle" id="headerSubtitle">Track how AI platforms reference your business</p>
            </div>
            <button class="scan-btn" id="scanBtn" onclick="runAIScan()">Run AI Scan</button>
        </header>

        <div class="stats-row">
            <div class="mini-stat"><div class="value" id="overallScore" style="color:#667eea;">--</div><div class="label">Overall AI Visibility</div></div>
            <div class="mini-stat"><div class="value" id="platformsMentioned" style="color:#28a745;">--</div><div class="label">Platforms Mentioning</div></div>
            <div class="mini-stat"><div class="value" id="queriesTested" style="color:#17a2b8;">--</div><div class="label">Queries Tested</div></div>
            <div class="mini-stat"><div class="value" id="mentionRate" style="color:#fd7e14;">--</div><div class="label">Mention Rate</div></div>
        </div>

        <div class="platform-grid" id="platformGrid"></div>

        <div class="card">
            <h2>AI Query Results</h2>
            <p style="color:#888; font-size:0.85rem; margin-bottom:15px;">How AI platforms respond when asked about your industry and services</p>
            <div id="queryResults"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Running AI visibility scan...</p></div></div>
        </div>

        <div class="card">
            <h2>Recommendations to Improve AI Visibility</h2>
            <div id="recommendations"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <script src="/sidebar.js"></script>
    <script>
        let clientConfig = {};

        const AI_PLATFORMS = [
            { name: 'ChatGPT (OpenAI)', icon: 'GPT', color: '#10a37f' },
            { name: 'Google Gemini', icon: 'G', color: '#4285f4' },
            { name: 'Claude (Anthropic)', icon: 'C', color: '#764ba2' },
            { name: 'Perplexity AI', icon: 'P', color: '#1a1a2e' },
            { name: 'Microsoft Copilot', icon: 'Co', color: '#00bcf2' },
            { name: 'Google SGE', icon: 'SGE', color: '#ea4335' }
        ];

        async function init() {
            initSidebar('/ai-discovery');
            try {
                const cfgRes = await fetch('/api/config');
                clientConfig = await cfgRes.json();
                document.getElementById('headerSubtitle').textContent = `AI visibility tracking for ${clientConfig.name || clientConfig.domain}`;
                await runAIScan();
            } catch(e) { console.error('Init error:', e); }
        }

        async function runAIScan() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = 'Scanning...';
            document.getElementById('platformGrid').innerHTML = '<div class="loading" style="grid-column:1/-1;"><div class="spinner"></div><p style="margin-top:10px;">Scanning web presence for ' + (clientConfig.name || clientConfig.domain) + '...</p></div>';
            document.getElementById('queryResults').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('recommendations').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch(`/api/ai-discovery/scan?domain=${encodeURIComponent(clientConfig.domain)}&name=${encodeURIComponent(clientConfig.name || clientConfig.domain)}`);
                const data = await res.json();

                if (data.success) {
                    renderPlatforms(data.platforms);
                    renderSignals(data.signals);
                    renderQueryResults(data.queries, data.signals);
                    renderRecommendations(data.recommendations);

                    const totalMentioning = data.platforms.filter(p => p.score >= 40).length;
                    document.getElementById('overallScore').textContent = data.overallScore + '%';
                    document.getElementById('platformsMentioned').textContent = totalMentioning + '/' + data.platforms.length;
                    document.getElementById('queriesTested').textContent = data.queries.length;
                    document.getElementById('mentionRate').textContent = Math.round((totalMentioning / data.platforms.length) * 100) + '%';
                } else {
                    document.getElementById('platformGrid').innerHTML = '<p style="color:#dc3545;padding:20px;">Scan failed.</p>';
                }
            } catch(e) {
                document.getElementById('platformGrid').innerHTML = '<p style="color:#dc3545;padding:20px;">Scan error: ' + e.message + '</p>';
            }

            btn.disabled = false;
            btn.textContent = 'Run AI Scan';
        }

        function renderPlatforms(platforms) {
            const grid = document.getElementById('platformGrid');
            grid.innerHTML = platforms.map(r => {
                const level = r.score >= 65 ? 'high' : r.score >= 40 ? 'medium' : 'low';
                const desc = level === 'high' ? 'Strong presence' : level === 'medium' ? 'Moderate presence' : 'Needs improvement';
                return `<div class="platform-card ${level}">
                    <div class="platform-header">
                        <div class="platform-name">${r.name}</div>
                        <div class="platform-score">${r.score}%</div>
                    </div>
                    <div class="platform-detail">${desc}</div>
                    <div class="platform-bar"><div class="platform-bar-fill" style="width:${r.score}%; background:${r.color};"></div></div>
                </div>`;
            }).join('');
        }

        function renderSignals(signals) {
            // Add a signals summary card after the platform grid
            const grid = document.getElementById('platformGrid');
            const socialList = (signals.socialProfiles || []).map(s => s.replace('.com','')).join(', ') || 'None found';
            const schemaList = (signals.schemaTypes || []).join(', ') || 'None';
            grid.insertAdjacentHTML('afterend', `
                <div class="card" style="margin-top:20px;">
                    <h2>Web Presence Signals Detected</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:10px;">
                        <div style="padding:12px;background:${signals.schema?'#d4edda':'#f8d7da'};border-radius:8px;"><strong>${signals.schema?'Yes':'No'}</strong> - Schema Markup</div>
                        <div style="padding:12px;background:${signals.localBusiness?'#d4edda':'#f8d7da'};border-radius:8px;"><strong>${signals.localBusiness?'Yes':'No'}</strong> - Business Schema</div>
                        <div style="padding:12px;background:${signals.hasAboutPage?'#d4edda':'#f8d7da'};border-radius:8px;"><strong>${signals.hasAboutPage?'Yes':'No'}</strong> - About Page</div>
                        <div style="padding:12px;background:${signals.wikipedia?'#d4edda':'#f8d7da'};border-radius:8px;"><strong>${signals.wikipedia?'Yes':'No'}</strong> - Wikipedia</div>
                        <div style="padding:12px;background:${signals.citations>=5?'#d4edda':signals.citations>=1?'#fff3cd':'#f8d7da'};border-radius:8px;"><strong>${signals.citations}</strong> - Brand Citations</div>
                        <div style="padding:12px;background:${signals.socialProfiles?.length>=3?'#d4edda':signals.socialProfiles?.length>=1?'#fff3cd':'#f8d7da'};border-radius:8px;"><strong>${signals.socialProfiles?.length||0}</strong> - Social Profiles</div>
                    </div>
                    <p style="color:#888;font-size:0.85rem;margin-top:12px;">Social: ${socialList} | Schema types: ${schemaList} | Content depth: ${signals.contentDepth||0} words</p>
                </div>
            `);
        }

        function renderQueryResults(queries, signals) {
            const container = document.getElementById('queryResults');
            // Use signals to estimate which platforms would mention the business
            const platformNames = ['ChatGPT', 'Gemini', 'Claude', 'Perplexity', 'Copilot', 'SGE'];
            const hasGoodPresence = signals.citations >= 5 || signals.schema;

            container.innerHTML = `<table><thead><tr><th>Sample Query</th><th>Likelihood of Mention</th><th>Why</th></tr></thead><tbody>${
                queries.map(q => {
                    let likelihood = 'Low';
                    let reason = 'Limited web presence signals';
                    if (signals.citations >= 10 && signals.schema) { likelihood = 'High'; reason = 'Strong citations + schema markup'; }
                    else if (signals.citations >= 5) { likelihood = 'Medium'; reason = signals.citations + ' brand citations found'; }
                    else if (signals.schema) { likelihood = 'Medium'; reason = 'Schema markup helps AI understanding'; }
                    else if (signals.brandMentions >= 3) { likelihood = 'Medium'; reason = 'Some brand mentions online'; }

                    const color = likelihood === 'High' ? '#28a745' : likelihood === 'Medium' ? '#ffc107' : '#dc3545';
                    return `<tr><td><strong>${q}</strong></td><td><span class="badge" style="background:${color}20;color:${color};">${likelihood}</span></td><td style="font-size:0.85rem;color:#666;">${reason}</td></tr>`;
                }).join('')
            }</tbody></table>`;
        }

        function renderRecommendations(recs) {
            const container = document.getElementById('recommendations');
            container.innerHTML = `<table><thead><tr><th>Recommendation</th><th>Impact</th><th>Status</th></tr></thead><tbody>${
                recs.map(r => {
                    const impactColor = r.impact === 'High' ? '#dc3545' : r.impact === 'Medium' ? '#ffc107' : '#28a745';
                    const badgeCls = r.status === 'Done' ? 'badge-yes' : r.status === 'Missing' ? 'badge-no' : 'badge-partial';
                    return `<tr><td>${r.rec}</td><td style="color:${impactColor};font-weight:600;">${r.impact}</td><td><span class="badge ${badgeCls}">${r.status}</span></td></tr>`;
                }).join('')
            }</tbody></table>`;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
