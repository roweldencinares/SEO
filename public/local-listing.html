<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local SEO & Listings - SEO Dashboard</title>
    <link rel="stylesheet" href="/sidebar.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { color: #333; font-size: 1.8rem; font-weight: 700; }
        .subtitle { color: #666; font-size: 0.95rem; }
        .scan-btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .scan-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .scan-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .biz-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .biz-card h2 { font-size: 1.2rem; color: #333; margin-bottom: 15px; }
        .biz-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .biz-field { padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .biz-field .field-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .biz-field .field-value { font-size: 0.95rem; color: #333; font-weight: 500; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h2 { font-size: 1.2rem; color: #333; margin-bottom: 15px; }
        .directory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .dir-card { border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; }
        .dir-card.listed { border-color: #28a745; background: #f8fff9; }
        .dir-card.not-listed { border-color: #ffc107; background: #fffef5; }
        .dir-card.error { border-color: #dc3545; background: #fff5f5; }
        .dir-icon { font-size: 2rem; margin-bottom: 8px; }
        .dir-name { font-weight: 600; color: #333; margin-bottom: 4px; }
        .dir-status { font-size: 0.85rem; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-top: 8px; }
        .dir-card.listed .dir-status { background: #d4edda; color: #155724; }
        .dir-card.not-listed .dir-status { background: #fff3cd; color: #856404; }
        .dir-card.error .dir-status { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; border-bottom: 2px solid #e9ecef; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; color: #333; }
        tr:hover { background: #f8f9fa; }
        .severity-high { color: #dc3545; font-weight: 600; }
        .severity-medium { color: #ffc107; font-weight: 600; }
        .severity-low { color: #28a745; font-weight: 600; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .mini-stat { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .mini-stat .value { font-size: 1.6rem; font-weight: 700; color: #333; }
        .mini-stat .label { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .loading { text-align: center; padding: 30px; color: #888; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Local SEO & Listings</h1>
                <p class="subtitle" id="headerSubtitle">Manage your local directory presence</p>
            </div>
            <button class="scan-btn" id="scanBtn" onclick="runScan()">Scan Listings</button>
        </header>

        <div class="stats-row" id="statsRow">
            <div class="mini-stat"><div class="value" id="listedCount">--</div><div class="label">Directories Listed</div></div>
            <div class="mini-stat"><div class="value" id="notListedCount">--</div><div class="label">Not Listed</div></div>
            <div class="mini-stat"><div class="value" id="accuracyScore">--</div><div class="label">NAP Consistency</div></div>
            <div class="mini-stat"><div class="value" id="localScore">--</div><div class="label">Local SEO Score</div></div>
        </div>

        <div class="biz-card">
            <h2>Business Information (NAP)</h2>
            <div class="biz-info" id="bizInfo">
                <div class="biz-field"><div class="field-label">Business Name</div><div class="field-value" id="bizName">Loading...</div></div>
                <div class="biz-field"><div class="field-label">Website</div><div class="field-value" id="bizWebsite">Loading...</div></div>
                <div class="biz-field"><div class="field-label">Phone</div><div class="field-value" id="bizPhone">Loading...</div></div>
                <div class="biz-field"><div class="field-label">Email</div><div class="field-value" id="bizEmail">Loading...</div></div>
                <div class="biz-field"><div class="field-label">Location</div><div class="field-value" id="bizLocation">Loading...</div></div>
                <div class="biz-field"><div class="field-label">Industry</div><div class="field-value" id="bizIndustry">Loading...</div></div>
            </div>
        </div>

        <div class="card">
            <h2>Directory Status</h2>
            <div class="directory-grid" id="directoryGrid">
                <div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Checking directories...</p></div>
            </div>
        </div>

        <div class="card">
            <h2>Local SEO Issues</h2>
            <div id="issuesContainer"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Analyzing issues...</p></div></div>
        </div>
    </div>

    <script src="/sidebar.js"></script>
    <script>
        let clientConfig = {};

        const DIRECTORIES = [
            { name: 'Google Business', icon: 'G', checkUrl: 'google.com/maps' },
            { name: 'Bing Places', icon: 'B', checkUrl: 'bing.com/maps' },
            { name: 'Yelp', icon: 'Y', checkUrl: 'yelp.com' },
            { name: 'Facebook', icon: 'F', checkUrl: 'facebook.com' },
            { name: 'Apple Maps', icon: 'A', checkUrl: 'maps.apple.com' },
            { name: 'BBB', icon: 'BBB', checkUrl: 'bbb.org' },
            { name: 'Yellow Pages', icon: 'YP', checkUrl: 'yellowpages.com' },
            { name: 'Angi', icon: 'An', checkUrl: 'angi.com' },
            { name: 'Thumbtack', icon: 'T', checkUrl: 'thumbtack.com' },
            { name: 'HomeAdvisor', icon: 'HA', checkUrl: 'homeadvisor.com' },
            { name: 'LinkedIn', icon: 'in', checkUrl: 'linkedin.com' },
            { name: 'Nextdoor', icon: 'N', checkUrl: 'nextdoor.com' }
        ];

        async function init() {
            initSidebar('/local-listing');
            try {
                const cfgRes = await fetch('/api/config');
                clientConfig = await cfgRes.json();
                document.getElementById('headerSubtitle').textContent = `Local presence for ${clientConfig.name || clientConfig.domain}`;
                document.getElementById('bizName').textContent = clientConfig.name || 'Not set';
                document.getElementById('bizWebsite').textContent = clientConfig.domain || 'Not set';
                document.getElementById('bizPhone').textContent = clientConfig.contactPhone || 'Not set';
                document.getElementById('bizEmail').textContent = clientConfig.contactEmail || 'Not set';
                document.getElementById('bizLocation').textContent = clientConfig.location || 'Not set';
                document.getElementById('bizIndustry').textContent = clientConfig.industry || 'Not set';
                await runScan();
            } catch(e) { console.error('Init error:', e); }
        }

        async function runScan() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = 'Scanning...';
            document.getElementById('directoryGrid').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Scanning real directories for ' + (clientConfig.name || clientConfig.domain) + '...</p></div>';
            document.getElementById('issuesContainer').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch(`/api/local-listing/scan?domain=${encodeURIComponent(clientConfig.domain)}&name=${encodeURIComponent(clientConfig.name || clientConfig.domain)}`);
                const data = await res.json();

                if (data.success) {
                    renderDirectories(data.directories);
                    renderIssues(data);
                    document.getElementById('listedCount').textContent = data.stats.listed;
                    document.getElementById('notListedCount').textContent = data.stats.notListed;
                    document.getElementById('accuracyScore').textContent = data.stats.napConsistency;
                    document.getElementById('localScore').textContent = data.stats.localScore + '/100';
                } else {
                    document.getElementById('directoryGrid').innerHTML = '<p style="color:#dc3545;padding:20px;">Scan failed: ' + (data.error || 'Unknown error') + '</p>';
                }
            } catch(e) {
                document.getElementById('directoryGrid').innerHTML = '<p style="color:#dc3545;padding:20px;">Scan failed: ' + e.message + '</p>';
            }

            btn.disabled = false;
            btn.textContent = 'Scan Listings';
        }

        function renderDirectories(dirs) {
            const grid = document.getElementById('directoryGrid');
            grid.innerHTML = dirs.map(d => {
                const cls = d.listed ? 'listed' : 'not-listed';
                const statusText = d.listed ? 'Listed' : 'Not Found';
                return `<div class="dir-card ${cls}">
                    <div class="dir-icon">${d.icon}</div>
                    <div class="dir-name">${d.name}</div>
                    <div class="dir-status">${statusText}</div>
                </div>`;
            }).join('');
        }

        function renderIssues(data) {
            const container = document.getElementById('issuesContainer');
            const issues = [];
            const ws = data.websiteSignals || {};

            if (!ws.hasSchema) issues.push({ issue: 'No structured data (JSON-LD) found on website', severity: 'high', action: 'Add LocalBusiness schema markup' });
            if (!ws.hasLocalBusiness) issues.push({ issue: 'No LocalBusiness schema detected', severity: 'high', action: 'Add LocalBusiness or Organization schema to homepage' });
            if (!ws.hasAddress) issues.push({ issue: 'Business address not clearly visible on website', severity: 'high', action: 'Add address to footer and contact page' });
            if (!ws.hasPhone) issues.push({ issue: 'Phone number not found or mismatched on website', severity: 'high', action: 'Ensure phone matches across all listings' });
            if (!ws.hasGoogleMaps) issues.push({ issue: 'No Google Maps embed found on website', severity: 'medium', action: 'Add Google Maps to contact page' });

            const notListed = (data.directories || []).filter(d => !d.listed);
            notListed.forEach(d => {
                issues.push({ issue: `Not found on ${d.name}`, severity: 'medium', action: `Create or claim your ${d.name} listing` });
            });

            if (!issues.length) { container.innerHTML = '<p style="color:#28a745; padding:20px; font-weight:600;">All checks passed - great local SEO presence!</p>'; return; }

            container.innerHTML = `<table><thead><tr><th>Issue</th><th>Severity</th><th>Action</th></tr></thead><tbody>${
                issues.map(i => `<tr><td>${i.issue}</td><td class="severity-${i.severity}">${i.severity.toUpperCase()}</td><td>${i.action}</td></tr>`).join('')
            }</tbody></table>`;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
