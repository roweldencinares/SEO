<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indexation Control - Spearity Marketing</title>

    
    

    <!-- Shared Sidebar Styles -->
    <link rel="stylesheet" href="/sidebar.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            margin-left: 260px;
            padding: 30px;
            max-width: calc(100% - 260px);
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-tab {
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .panel {
            display: none;
            animation: fadeIn 0.3s;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #1a202c;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 15px;
            margin-top: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        

        

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .result-box {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .success {
            background: #f0fdf4;
            border-color: #86efac;
            color: #166534;
        }

        .error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        .warning {
            background: #fffbeb;
            border-color: #fde047;
            color: #854d0e;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .issue-list {
            list-style: none;
            margin-top: 15px;
        }

        .issue-list li {
            padding: 12px;
            background: #f7fafc;
            border-left: 4px solid #cbd5e0;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .issue-list li.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .issue-list li.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .path-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .path-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path-item input {
            flex: 1;
        }

        .path-item button {
            padding: 8px 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-path-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin: 0 0 10px 0;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
        }

        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

    </style>
</head>
<body>
    <div class="container">
        <a href="/dashboard" class="back-link">‚Üê Back to Dashboard</a>

        <div class="header">
            <h1>üõ°Ô∏è Indexation Control</h1>
            <p>Manage robots.txt, meta-noindex tags, and canonical URLs</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('robots')">Robots.txt</div>
            <div class="nav-tab" onclick="switchTab('noindex')">Meta Noindex</div>
            <div class="nav-tab" onclick="switchTab('canonical')">Canonical Tags</div>
            <div class="nav-tab" onclick="switchTab('audit')">Full Audit</div>
            <div class="nav-tab" onclick="switchTab('gsc-status')">üîç GSC Index</div>
            <div class="nav-tab" onclick="switchTab('gsc-coverage')">üìä GSC Coverage</div>
            <div class="nav-tab" onclick="switchTab('gsc-summary')">üìà GSC Dashboard</div>
            <div class="nav-tab" onclick="switchTab('gsc-bulk')">üîé Bulk Check</div>
        </div>

        <!-- ROBOTS.TXT PANEL -->
        <div id="robots-panel" class="panel active">
            <div class="card">
                <h2>ü§ñ Robots.txt Generator</h2>

                <div class="form-group">
                    <label>Sitemap URL</label>
                    <input type="text" id="sitemap-url" value="https://www.spearity.com/sitemap.xml" placeholder="https://example.com/sitemap.xml">
                </div>

                <h3>Allowed Paths</h3>
                <div id="allowed-paths" class="path-list">
                    <div class="path-item">
                        <input type="text" value="/" placeholder="/path/">
                    </div>
                    <div class="path-item">
                        <input type="text" value="/services/" placeholder="/path/">
                    </div>
                </div>
                <button class="add-path-btn" onclick="addPath('allowed')">+ Add Allowed Path</button>

                <h3>Disallowed Paths</h3>
                <div id="disallowed-paths" class="path-list">
                    <div class="path-item">
                        <input type="text" value="/admin/" placeholder="/path/">
                    </div>
                    <div class="path-item">
                        <input type="text" value="/wp-admin/" placeholder="/path/">
                    </div>
                </div>
                <button class="add-path-btn" onclick="addPath('disallowed')">+ Add Disallowed Path</button>

                <div class="form-group">
                    <label>Crawl Delay (seconds)</label>
                    <input type="number" id="crawl-delay" value="1" min="0" max="10">
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="generateRobotsTxt()">Generate Robots.txt</button>
                    <button class="btn btn-secondary" onclick="validateRobotsTxt()">Validate Existing</button>
                </div>

                <div id="robots-result"></div>
            </div>
        </div>

        <!-- NOINDEX PANEL -->
        <div id="noindex-panel" class="panel">
            <div class="card">
                <h2>üö´ Meta Noindex Manager</h2>

                <div class="form-group">
                    <label>Exclude Categories (comma-separated)</label>
                    <input type="text" id="exclude-categories" value="drafts, private" placeholder="drafts, private, uncategorized">
                </div>

                <div class="form-group">
                    <label>Exclude Tags (comma-separated)</label>
                    <input type="text" id="exclude-tags" value="noindex, private" placeholder="noindex, private, test">
                </div>

                <div class="form-group">
                    <label>Exclude Post Types (comma-separated)</label>
                    <input type="text" id="exclude-post-types" value="draft, private" placeholder="draft, private, revision">
                </div>

                <button class="btn" onclick="generateNoindexRules()">Generate Noindex Rules</button>

                <div id="noindex-result"></div>

                <div class="card" style="margin-top: 30px; background: #fffbeb; border: 2px solid #fde047;">
                    <h3>‚ö†Ô∏è Apply to WordPress</h3>
                    <p style="color: #854d0e; margin-bottom: 15px;">Requires WordPress REST API credentials</p>

                    <div class="form-group">
                        <label>WordPress API URL</label>
                        <input type="text" id="wp-api-url" value="https://www.spearity.com/wp-json" placeholder="https://example.com/wp-json">
                    </div>

                    <div class="form-group">
                        <label>Post IDs (comma-separated)</label>
                        <input type="text" id="wp-post-ids" placeholder="123, 456, 789">
                    </div>

                    <button class="btn" onclick="applyNoindexToWP()" disabled>Apply Noindex (Coming Soon)</button>
                </div>
            </div>
        </div>

        <!-- CANONICAL PANEL -->
        <div id="canonical-panel" class="panel">
            <div class="card">
                <h2>üîó Canonical Tag Checker</h2>

                <div class="form-group">
                    <label>URL to Check</label>
                    <input type="text" id="canonical-url" value="https://www.spearity.com" placeholder="https://example.com/page">
                </div>

                <button class="btn" onclick="checkCanonical()">Check Canonical Tag</button>

                <div id="canonical-result"></div>
            </div>
        </div>

        <!-- AUDIT PANEL -->
        <div id="audit-panel" class="panel">
            <div class="card">
                <h2>üìä Full Indexation Audit</h2>
                <p style="color: #718096; margin-bottom: 20px;">Comprehensive audit of robots.txt, canonical tags, and indexation status across your entire site.</p>

                <div class="form-group">
                    <label>Sitemap URL</label>
                    <input type="text" id="audit-sitemap-url" value="https://www.spearity.com/sitemap.xml" placeholder="https://example.com/sitemap.xml">
                </div>

                <div class="form-group">
                    <label>Max Pages to Audit</label>
                    <input type="number" id="audit-max-pages" value="50" min="10" max="500">
                </div>

                <button class="btn" onclick="runFullAudit()">Run Full Audit</button>

                <div id="audit-result"></div>
            </div>
        </div>

        <!-- GSC-POWERED INDEXATION PANELS -->
        <!-- Load from external file for maintainability -->
        <script>
            // Load GSC panels
            fetch('/indexation-gsc-panel.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Extract and append panels
                    const panels = doc.querySelectorAll('.panel');
                    const container = document.querySelector('.container');
                    panels.forEach(panel => {
                        container.appendChild(panel);
                    });

                    // Execute any scripts in the loaded HTML
                    const scripts = doc.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        document.body.appendChild(newScript);
                    });
                });
        </script>
    </div>

    <script>
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(tabName + '-panel').classList.add('active');
        }

        function addPath(type) {
            const container = document.getElementById(type + '-paths');
            const pathItem = document.createElement('div');
            pathItem.className = 'path-item';
            pathItem.innerHTML = `
                <input type="text" placeholder="/path/">
                <button onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(pathItem);
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Processing...</p>
                </div>
            `;
        }

        async function generateRobotsTxt() {
            showLoading('robots-result');

            const allowedPaths = Array.from(document.querySelectorAll('#allowed-paths input'))
                .map(input => input.value)
                .filter(v => v);

            const disallowedPaths = Array.from(document.querySelectorAll('#disallowed-paths input'))
                .map(input => input.value)
                .filter(v => v);

            const config = {
                sitemap: document.getElementById('sitemap-url').value,
                allowedPaths,
                disallowedPaths,
                crawlDelay: parseInt(document.getElementById('crawl-delay').value)
            };

            try {
                const response = await fetch('/api/indexation/robots/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('robots-result').innerHTML = `
                        <div class="result-box success">
                            <strong>‚úÖ Robots.txt Generated Successfully</strong><br><br>
                            Allowed: ${data.rules.allowed} paths<br>
                            Disallowed: ${data.rules.disallowed} paths<br>
                            Custom rules: ${data.rules.custom}<br><br>
                            <strong>Generated Content:</strong><br><br>
                            ${data.robotsTxt}
                        </div>
                        <button class="btn" style="margin-top: 15px;" onclick="copyToClipboard(\`${data.robotsTxt.replace(/`/g, '\\`')}\`)">Copy to Clipboard</button>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('robots-result').innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function validateRobotsTxt() {
            const content = prompt('Paste your robots.txt content:');
            if (!content) return;

            showLoading('robots-result');

            try {
                const response = await fetch('/api/indexation/robots/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (data.success) {
                    const validation = data.validation;
                    const issuesList = validation.issues.length > 0
                        ? validation.issues.map(issue => `
                            <li class="${issue.severity}">
                                <strong>${issue.severity.toUpperCase()}:</strong> ${issue.message}
                                ${issue.line ? `(Line ${issue.line})` : ''}
                            </li>
                        `).join('')
                        : '<li>No issues found!</li>';

                    document.getElementById('robots-result').innerHTML = `
                        <div class="result-box ${validation.valid ? 'success' : 'error'}">
                            <strong>${validation.valid ? '‚úÖ' : '‚ùå'} Validation ${validation.valid ? 'Passed' : 'Failed'}</strong><br><br>
                            Lines: ${validation.lineCount}<br>
                            Issues: ${validation.issues.length}<br><br>
                            <ul class="issue-list">${issuesList}</ul>
                        </div>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('robots-result').innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function generateNoindexRules() {
            showLoading('noindex-result');

            const criteria = {
                excludeCategories: document.getElementById('exclude-categories').value.split(',').map(s => s.trim()),
                excludeTags: document.getElementById('exclude-tags').value.split(',').map(s => s.trim()),
                excludePostTypes: document.getElementById('exclude-post-types').value.split(',').map(s => s.trim())
            };

            try {
                const response = await fetch('/api/indexation/noindex/rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(criteria)
                });

                const data = await response.json();

                if (data.success) {
                    const rulesList = data.rules.map(rule => `
                        <li>
                            <strong>${rule.type}:</strong> "${rule.pattern}"<br>
                            Action: <code>${rule.action}</code><br>
                            Reason: ${rule.reason}
                        </li>
                    `).join('');

                    document.getElementById('noindex-result').innerHTML = `
                        <div class="result-box success">
                            <strong>‚úÖ Generated ${data.total} Noindex Rules</strong><br><br>
                            <ul class="issue-list">${rulesList}</ul>
                        </div>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('noindex-result').innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function checkCanonical() {
            showLoading('canonical-result');

            const url = document.getElementById('canonical-url').value;

            try {
                const response = await fetch(`/api/indexation/canonical/check?url=${encodeURIComponent(url)}`);
                const data = await response.json();

                if (data.success) {
                    const audit = data.audit;
                    console.log('Audit data:', audit); // Debug log
                    const urlString = typeof audit.url === 'string' ? audit.url : url;
                    const issuesList = audit.issues.length > 0
                        ? audit.issues.map(issue => `
                            <li class="${issue.severity}">
                                <strong>${issue.severity.toUpperCase()}:</strong> ${issue.message}<br>
                                ${issue.canonical ? `Canonical: ${issue.canonical}<br>` : ''}
                                ${issue.actual ? `Actual: ${issue.actual}` : ''}
                            </li>
                        `).join('')
                        : '<li class="success">‚úÖ No issues found!</li>';

                    document.getElementById('canonical-result').innerHTML = `
                        <div class="result-box ${audit.health === 'healthy' ? 'success' : 'warning'}">
                            <strong>Health: ${audit.health ? audit.health.toUpperCase() : 'UNKNOWN'}</strong>
                            <span class="badge ${audit.health === 'healthy' ? 'success' : 'warning'}">${audit.issues.length} issues</span><br><br>
                            URL: ${urlString}<br>
                            Canonical Tag: ${audit.canonical || 'None'}<br><br>
                            <ul class="issue-list">${issuesList}</ul>
                        </div>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('canonical-result').innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function runFullAudit() {
            showLoading('audit-result');

            const config = {
                sitemapUrl: document.getElementById('audit-sitemap-url').value,
                maxPages: parseInt(document.getElementById('audit-max-pages').value)
            };

            try {
                const response = await fetch('/api/indexation/audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    const audit = data.audit;
                    const summary = audit.summary;

                    document.getElementById('audit-result').innerHTML = `
                        <div class="grid">
                            <div class="stat-card">
                                <h3>Total Pages</h3>
                                <div class="value">${summary.totalPages}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <h3>Healthy</h3>
                                <div class="value">${summary.healthy}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <h3>Unhealthy</h3>
                                <div class="value">${summary.unhealthy}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                <h3>Critical Issues</h3>
                                <div class="value">${summary.criticalIssues}</div>
                            </div>
                        </div>

                        <div class="result-box" style="margin-top: 20px;">
                            <strong>üìä Audit Summary</strong><br><br>
                            Audited: ${summary.totalPages} pages<br>
                            Healthy: ${summary.healthy} (${((summary.healthy / summary.totalPages) * 100).toFixed(1)}%)<br>
                            Warnings: ${summary.warnings}<br>
                            Critical Issues: ${summary.criticalIssues}<br><br>
                            <strong>Timestamp:</strong> ${new Date(audit.timestamp).toLocaleString()}
                        </div>
                    `;

                    if (audit.criticalIssues.length > 0) {
                        const issuesList = audit.criticalIssues.map(issue => `
                            <li class="critical">
                                <strong>${issue.type}:</strong> ${issue.message}<br>
                                ${issue.url ? `URL: ${issue.url}` : ''}
                            </li>
                        `).join('');

                        document.getElementById('audit-result').innerHTML += `
                            <div class="result-box error" style="margin-top: 20px;">
                                <strong>üö® Top Critical Issues</strong><br><br>
                                <ul class="issue-list">${issuesList}</ul>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('audit-result').innerHTML = `
                    <div class="result-box error">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Copied to clipboard!');
            });
        }
    </script>

    <!-- Sidebar Integration -->
    <script src="/sidebar.js"></script>
    <script>
        window.addEventListener('load', () => {
            initSidebar('/indexation-control');
        });
    </script>
</body>
</html>
