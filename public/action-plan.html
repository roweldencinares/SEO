<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Plan - SEO Dashboard</title>
    <link rel="stylesheet" href="/sidebar.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 35px 30px; border-radius: 15px; margin-bottom: 25px; }
        .header h1 { font-size: 2rem; margin-bottom: 8px; }
        .header .subtitle { opacity: 0.95; font-size: 1rem; }
        .progress-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h2 { color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 1.3rem; }
        .progress-bar { height: 28px; background: #e0e0e0; border-radius: 14px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.9rem; transition: width 0.8s ease; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .stat-item { text-align: center; padding: 14px; background: #f8f9fa; border-radius: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 0.8rem; color: #666; margin-top: 4px; }
        .score-row { margin: 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .score-row span { color: #555; }
        .score-row strong { color: #333; }
        .score-bar { flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; margin: 0 12px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s; }
        .section-label { padding: 12px 18px; border-radius: 10px; margin-bottom: 15px; font-weight: 600; }
        .label-quick { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .label-medium { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .label-long { background: #e2e3e5; border-left: 4px solid #6c757d; color: #383d41; }
        .action-item { display: flex; gap: 15px; padding: 18px; border: 2px solid #e9ecef; border-radius: 12px; margin-bottom: 12px; transition: all 0.3s; align-items: flex-start; }
        .action-item:hover { border-color: #667eea; box-shadow: 0 3px 15px rgba(102,126,234,0.1); }
        .action-item.done { background: #f0f8f0; border-color: #28a745; opacity: 0.7; }
        .action-num { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
        .action-body { flex: 1; }
        .action-title { font-size: 1.05rem; font-weight: 600; color: #333; margin-bottom: 6px; }
        .action-desc { color: #666; font-size: 0.9rem; line-height: 1.5; margin-bottom: 10px; }
        .action-meta { display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-medium { background: #fff3cd; color: #856404; }
        .badge-low { background: #d4edda; color: #155724; }
        .badge-time { background: #e8eaf6; color: #3f51b5; }
        .badge-category { background: #e0f2f1; color: #00695c; }
        .action-btn { padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s; }
        .btn-done { background: #28a745; color: white; }
        .btn-done:hover { background: #218838; }
        .btn-link { background: #e9ecef; color: #333; }
        .btn-link:hover { background: #dee2e6; }
        .impact-card { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; padding: 25px; color: white; margin-top: 20px; }
        .impact-card h3 { margin-bottom: 12px; }
        .impact-card p { opacity: 0.95; line-height: 1.7; margin-bottom: 6px; }
        .loading { text-align: center; padding: 50px; color: #888; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 900px) { .progress-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="headerTitle">Action Plan</h1>
            <p class="subtitle" id="headerSub">Prioritized SEO improvements based on your site audit</p>
        </div>

        <div id="loadingState" class="loading"><div class="spinner"></div><p>Analyzing your site and generating action plan...</p></div>

        <div id="mainContent" style="display:none;">
            <div class="progress-row">
                <div class="card">
                    <h2>Overall Progress</h2>
                    <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:0%;">0%</div></div>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-value" id="completedCount">0</div><div class="stat-label">Completed</div></div>
                        <div class="stat-item"><div class="stat-value" id="pendingCount">0</div><div class="stat-label">Pending</div></div>
                        <div class="stat-item"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Total</div></div>
                    </div>
                </div>
                <div class="card">
                    <h2>Score Breakdown</h2>
                    <div id="scoreBreakdown"></div>
                </div>
            </div>

            <div class="card">
                <h2>Strategic Action Plan</h2>
                <div class="section-label label-quick">Quick Wins (1-2 Weeks) - Immediate impact</div>
                <div id="quickWins"></div>
                <div class="section-label label-medium" style="margin-top:25px;">Medium-Term (1-2 Months) - Build authority</div>
                <div id="mediumTerm"></div>
                <div class="section-label label-long" style="margin-top:25px;">Long-Term (3-6 Months) - Sustained growth</div>
                <div id="longTerm"></div>
            </div>

            <div class="impact-card" id="impactCard"></div>
        </div>
    </div>

    <script src="/sidebar.js"></script>
    <script>
        let clientConfig = {};
        let actions = [];
        const STORAGE_KEY = 'seo_action_plan_done';

        async function init() {
            initSidebar('/actions');
            try {
                const cfgRes = await fetch('/api/config');
                clientConfig = await cfgRes.json();
                document.getElementById('headerTitle').textContent = `${clientConfig.name || clientConfig.domain} - Action Plan`;
                document.getElementById('headerSub').textContent = `Prioritized improvements for ${clientConfig.domain}`;

                const siteUrl = 'https://' + clientConfig.domain;

                // Fetch all data in parallel
                const [auditRes, healthRes, aiRes, localRes] = await Promise.all([
                    fetch('/api/seo-agents/audit?url=' + encodeURIComponent(siteUrl)),
                    fetch('/api/seo-agents/health?site=' + encodeURIComponent(siteUrl)),
                    fetch('/api/ai-discovery/scan?domain=' + encodeURIComponent(clientConfig.domain) + '&name=' + encodeURIComponent(clientConfig.name || clientConfig.domain)),
                    fetch('/api/local-listing/scan?domain=' + encodeURIComponent(clientConfig.domain) + '&name=' + encodeURIComponent(clientConfig.name || clientConfig.domain))
                ]);

                const audit = await auditRes.json();
                const health = await healthRes.json();
                const ai = await aiRes.json();
                const local = await localRes.json();

                generateActions(audit, health, ai, local);
                renderPlan();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch(e) {
                console.error('Init error:', e);
                document.getElementById('loadingState').innerHTML = '<p style="color:#dc3545;">Error loading data: ' + e.message + '</p>';
            }
        }

        function getDone() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e) { return []; }
        }

        function toggleDone(id) {
            let done = getDone();
            if (done.includes(id)) done = done.filter(d => d !== id);
            else done.push(id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(done));
            renderPlan();
        }

        function generateActions(audit, health, ai, local) {
            actions = [];
            let id = 1;

            // From Audit
            if (audit.success && audit.data) {
                audit.data.checks.filter(c => !c.passed).forEach(c => {
                    const priority = c.weight >= 2 ? 'high' : 'medium';
                    const timeframe = c.weight >= 2 ? 'quick' : 'medium';
                    actions.push({ id: 'audit-' + id++, title: 'Fix: ' + c.name, desc: c.details, priority, timeframe, category: 'SEO Audit', link: '/website-audit' });
                });
            }

            // From Health
            if (health.success && health.data) {
                if (!health.data.checks.robots) actions.push({ id: 'health-' + id++, title: 'Create robots.txt file', desc: 'Your site is missing a robots.txt file. This tells search engines how to crawl your site.', priority: 'high', timeframe: 'quick', category: 'Technical SEO' });
                if (!health.data.checks.sitemap) actions.push({ id: 'health-' + id++, title: 'Submit XML Sitemap', desc: 'No sitemap.xml found. Create and submit to Google Search Console for faster indexing.', priority: 'high', timeframe: 'quick', category: 'Technical SEO' });
                if (!health.data.checks.meta) actions.push({ id: 'health-' + id++, title: 'Add meta description to homepage', desc: 'Your homepage is missing a meta description, hurting click-through rates from search.', priority: 'high', timeframe: 'quick', category: 'On-Page SEO' });
            }

            // From AI Discovery
            if (ai.success) {
                if (!ai.signals.schema) actions.push({ id: 'ai-' + id++, title: 'Add structured data (JSON-LD)', desc: 'No schema markup detected. Add LocalBusiness schema to help AI platforms understand your business.', priority: 'high', timeframe: 'quick', category: 'AI Visibility', link: '/ai-discovery' });
                if (!ai.signals.localBusiness) actions.push({ id: 'ai-' + id++, title: 'Add LocalBusiness schema', desc: 'Add Organization or LocalBusiness JSON-LD to your homepage for better entity recognition.', priority: 'high', timeframe: 'quick', category: 'AI Visibility' });
                if (!ai.signals.hasAboutPage) actions.push({ id: 'ai-' + id++, title: 'Create detailed About page', desc: 'No about page found. Create entity-rich content describing your business, team, and history.', priority: 'medium', timeframe: 'medium', category: 'AI Visibility' });
                if (ai.signals.socialProfiles && ai.signals.socialProfiles.length < 3) actions.push({ id: 'ai-' + id++, title: 'Add social media profile links', desc: `Only ${ai.signals.socialProfiles.length} social profiles linked from your site. Add links to Facebook, LinkedIn, Instagram, etc.`, priority: 'medium', timeframe: 'quick', category: 'AI Visibility' });
                if (ai.signals.citations < 5) actions.push({ id: 'ai-' + id++, title: 'Build brand citations online', desc: `Only ${ai.signals.citations} brand citations found. Get mentioned in industry publications, press, and review sites.`, priority: 'high', timeframe: 'long', category: 'AI Visibility' });
                if (!ai.signals.wikipedia) actions.push({ id: 'ai-' + id++, title: 'Build Wikipedia/Wikidata presence', desc: 'No Wikipedia presence found. This is a major signal for AI entity recognition.', priority: 'medium', timeframe: 'long', category: 'AI Visibility' });
            }

            // From Local Listing
            if (local.success) {
                const notListed = (local.directories || []).filter(d => !d.listed);
                notListed.slice(0, 6).forEach(d => {
                    actions.push({ id: 'local-' + id++, title: `Claim listing on ${d.name}`, desc: `Your business was not found on ${d.name}. Create or claim your listing to improve local visibility.`, priority: notListed.length > 6 ? 'high' : 'medium', timeframe: 'medium', category: 'Local SEO', link: '/local-listing' });
                });
                const ws = local.websiteSignals || {};
                if (!ws.hasGoogleMaps) actions.push({ id: 'local-' + id++, title: 'Add Google Maps embed to website', desc: 'No Google Maps integration found. Add an embedded map to your contact page.', priority: 'medium', timeframe: 'quick', category: 'Local SEO' });
                if (!ws.hasPhone) actions.push({ id: 'local-' + id++, title: 'Display phone number on website', desc: 'Phone number not found or not matching. Ensure it\'s visible in the header/footer.', priority: 'high', timeframe: 'quick', category: 'Local SEO' });
            }

            // Generic best practices
            actions.push({ id: 'gen-' + id++, title: 'Set up Google Analytics 4', desc: 'Connect GA4 to track visitor behavior, conversions, and traffic sources.', priority: 'medium', timeframe: 'quick', category: 'Analytics', link: '/integrations' });
            actions.push({ id: 'gen-' + id++, title: 'Create FAQ content for AI search', desc: 'Publish FAQ-style pages that AI assistants can reference when answering questions about your industry.', priority: 'medium', timeframe: 'medium', category: 'Content' });
            actions.push({ id: 'gen-' + id++, title: 'Build email subscriber list', desc: 'Start collecting emails from website visitors for monthly newsletters and promotions.', priority: 'low', timeframe: 'long', category: 'Email Marketing', link: '/email-campaigns' });
        }

        function renderPlan() {
            const done = getDone();
            const quick = actions.filter(a => a.timeframe === 'quick');
            const medium = actions.filter(a => a.timeframe === 'medium');
            const long = actions.filter(a => a.timeframe === 'long');

            renderActions('quickWins', quick, done);
            renderActions('mediumTerm', medium, done);
            renderActions('longTerm', long, done);

            const completedCount = done.filter(d => actions.some(a => a.id === d)).length;
            const totalCount = actions.length;
            const pendingCount = totalCount - completedCount;
            const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = progress + '%';

            // Score breakdown
            const categories = [...new Set(actions.map(a => a.category))];
            document.getElementById('scoreBreakdown').innerHTML = categories.slice(0, 5).map(cat => {
                const catActions = actions.filter(a => a.category === cat);
                const catDone = catActions.filter(a => done.includes(a.id)).length;
                const pct = Math.round((catDone / catActions.length) * 100);
                const color = pct >= 75 ? '#28a745' : pct >= 40 ? '#ffc107' : '#dc3545';
                return `<div class="score-row"><span>${cat}</span><div class="score-bar"><div class="score-bar-fill" style="width:${pct}%;background:${color};"></div></div><strong>${catDone}/${catActions.length}</strong></div>`;
            }).join('');

            // Impact card
            document.getElementById('impactCard').innerHTML = `
                <h3>Expected Impact</h3>
                <p><strong>Quick Wins:</strong> ${quick.length} actions that can be done in 1-2 weeks for immediate SEO improvements</p>
                <p><strong>Medium-Term:</strong> ${medium.length} actions over 1-2 months to build authority and local presence</p>
                <p><strong>Long-Term:</strong> ${long.length} actions for sustained growth over 3-6 months</p>
                <p style="margin-top:10px;"><strong>Progress:</strong> ${completedCount} of ${totalCount} completed (${progress}%)</p>
            `;
        }

        function renderActions(containerId, items, done) {
            const container = document.getElementById(containerId);
            if (!items.length) { container.innerHTML = '<p style="color:#28a745;padding:12px;">All done in this category!</p>'; return; }

            let num = 1;
            container.innerHTML = items.map(a => {
                const isDone = done.includes(a.id);
                return `<div class="action-item ${isDone ? 'done' : ''}">
                    <div class="action-num">${isDone ? '&#10003;' : num++}</div>
                    <div class="action-body">
                        <div class="action-title">${isDone ? '<s>' + a.title + '</s>' : a.title}</div>
                        <div class="action-desc">${a.desc}</div>
                        <div class="action-meta">
                            <span class="badge badge-${a.priority}">${a.priority.toUpperCase()}</span>
                            <span class="badge badge-category">${a.category}</span>
                            <button class="action-btn btn-done" onclick="toggleDone('${a.id}')">${isDone ? '&#8634; Undo' : '&#10003; Mark Done'}</button>
                            ${a.link ? `<a href="${a.link}" class="action-btn btn-link">View Details</a>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
