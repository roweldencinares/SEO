<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitive Intelligence - SEO Dashboard</title>
    <link rel="stylesheet" href="/sidebar.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 25px; color: white; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 1.8rem; font-weight: 700; }
        .subtitle { opacity: 0.9; font-size: 0.95rem; margin-top: 4px; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 22px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; }
        .btn-white { background: white; color: #667eea; }
        .btn-white:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-outline { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.4); }
        .btn-outline:hover { background: rgba(255,255,255,0.25); }
        .btn-sm { padding: 6px 14px; font-size: 0.8rem; border-radius: 6px; }
        .btn-danger { background: #f8d7da; color: #721c24; border: none; }
        .btn-danger:hover { background: #f1b0b7; }
        .btn-gradient { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; box-shadow: 0 4px 15px rgba(102,126,234,0.3); }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }

        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h2 { font-size: 1.15rem; color: #333; margin-bottom: 5px; font-weight: 700; }
        .card .card-desc { color: #888; font-size: 0.85rem; margin-bottom: 18px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #667eea; }
        .stat-card .label { color: #888; font-size: 0.82rem; margin-bottom: 6px; }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: #333; }
        .stat-card .sub { font-size: 0.8rem; margin-top: 4px; }
        .stat-card .sub.up { color: #28a745; }
        .stat-card .sub.down { color: #dc3545; }
        .stat-card:nth-child(2) { border-left-color: #28a745; }
        .stat-card:nth-child(3) { border-left-color: #ffc107; }
        .stat-card:nth-child(4) { border-left-color: #dc3545; }

        .comp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; margin-bottom: 25px; }
        .comp-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; transition: all 0.3s; border: 2px solid transparent; }
        .comp-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .comp-card .comp-domain { font-weight: 700; font-size: 1.05rem; color: #333; margin-bottom: 4px; }
        .comp-card .comp-name { color: #666; font-size: 0.85rem; margin-bottom: 10px; }
        .comp-card .comp-actions { display: flex; gap: 8px; margin-top: 12px; }
        .comp-remove { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; padding: 4px; }
        .comp-remove:hover { color: #dc3545; }
        .type-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .type-direct { background: #cce5ff; color: #004085; }
        .type-traditional-excavation { background: #fff3cd; color: #856404; }
        .type-utility-contractor { background: #d4edda; color: #155724; }
        .type-general { background: #e2e3e5; color: #383d41; }

        .empty-state { text-align: center; padding: 50px 20px; color: #888; }
        .empty-state h3 { color: #555; margin-bottom: 10px; }

        /* Gap Matrix */
        .gap-matrix { width: 100%; border-collapse: collapse; }
        .gap-matrix th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; border-bottom: 2px solid #e9ecef; }
        .gap-matrix td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .gap-matrix tr:hover { background: #f8f9fa; }
        .coverage-yes { color: #28a745; font-weight: 700; }
        .coverage-no { color: #ccc; }
        .gap-badge { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: #fff3cd; color: #856404; margin-left: 8px; }

        /* Tabs */
        .tab-nav { display: flex; gap: 0; border-bottom: 2px solid #e9ecef; margin-bottom: 20px; }
        .tab-btn { padding: 12px 22px; background: none; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #888; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-btn:hover { color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.82rem; border-bottom: 2px solid #e9ecef; }
        td { padding: 11px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.88rem; color: #333; }
        tr:hover { background: #f8f9fa; }
        .pos-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .pos-top3 { background: #d4edda; color: #155724; }
        .pos-top10 { background: #cce5ff; color: #004085; }
        .pos-top20 { background: #fff3cd; color: #856404; }
        .pos-low { background: #f8d7da; color: #721c24; }
        .tier-badge { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .tier-emergency { background: #f8d7da; color: #721c24; }
        .tier-money { background: #d4edda; color: #155724; }
        .tier-contract { background: #cce5ff; color: #004085; }
        .tier-trust { background: #e2e3e5; color: #383d41; }

        .vibe-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-left: 4px; }
        .vibe-target { background: #28a745; color: white; }
        .vibe-ignore { background: #6c757d; color: white; }
        .vibe-local { background: #667eea; color: white; }
        .vibe-almost { background: #ffc107; color: #333; }
        .vibe-urgent { background: #dc3545; color: white; }

        .serp-feature { display: inline-block; padding: 1px 7px; border-radius: 3px; font-size: 0.7rem; font-weight: 600; background: #f0f0f0; color: #555; margin-right: 3px; }
        .serp-map { background: #d4edda; color: #155724; }
        .serp-ads { background: #fff3cd; color: #856404; }
        .serp-snippet { background: #cce5ff; color: #004085; }

        .win-bar { display: inline-flex; align-items: center; gap: 6px; }
        .win-bar-track { width: 50px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; }
        .win-bar-fill { height: 100%; border-radius: 3px; }
        .win-high .win-bar-fill { background: #28a745; }
        .win-mid .win-bar-fill { background: #ffc107; }
        .win-low .win-bar-fill { background: #dc3545; }

        .cell-win { background: #d4edda44; }
        .cell-lose { background: #f8d7da44; }

        /* Charts */
        .chart-container { position: relative; height: 320px; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        /* Speed cards */
        .speed-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .speed-card { border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #e9ecef; }
        .speed-card .vital-name { font-size: 0.8rem; font-weight: 600; color: #888; margin-bottom: 5px; }
        .speed-card .vital-value { font-size: 1.4rem; font-weight: 700; }
        .speed-card.good { border-color: #28a745; }
        .speed-card.good .vital-value { color: #28a745; }
        .speed-card.poor { border-color: #dc3545; }
        .speed-card.poor .vital-value { color: #dc3545; }
        .speed-card.mid { border-color: #ffc107; }
        .speed-card.mid .vital-value { color: #856404; }

        /* Action plan */
        .action-item { display: flex; align-items: flex-start; gap: 12px; padding: 14px 0; border-bottom: 1px solid #f0f0f0; }
        .action-item:last-child { border-bottom: none; }
        .action-priority { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
        .priority-critical { background: #f8d7da; color: #721c24; }
        .priority-high { background: #fff3cd; color: #856404; }
        .priority-opportunity { background: #cce5ff; color: #004085; }
        .action-text { font-size: 0.9rem; color: #333; line-height: 1.5; }
        .action-impact { font-size: 0.8rem; color: #888; margin-top: 4px; }

        .loading { text-align: center; padding: 40px; color: #888; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal h3 { font-size: 1.3rem; margin-bottom: 20px; color: #333; }
        .modal label { display: block; font-weight: 600; font-size: 0.85rem; color: #555; margin-bottom: 5px; margin-top: 15px; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .modal input:focus, .modal select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end; }

        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { header { flex-direction: column; text-align: center; } }
    </style>
</head>
<body>
    <div class="container">

        <!-- HEADER -->
        <header>
            <div>
                <h1>Competitive Intelligence</h1>
                <p class="subtitle" id="headerSubtitle">Analyze your competitive landscape</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="analyzeAll()" id="analyzeAllBtn">Analyze All</button>
                <button class="btn btn-white" onclick="showAddModal()">+ Add Competitor</button>
            </div>
        </header>

        <!-- COMPETITOR CARDS -->
        <div id="compSection">
            <div id="compGrid" class="comp-grid"></div>
        </div>

        <!-- TIER SUMMARY STATS -->
        <div class="stats-grid" id="tierStats" style="display:none;">
            <div class="stat-card" style="border-left-color:#dc3545;"><div class="label">Emergency Keywords</div><div class="value" id="statEmergency">--</div><div class="sub" id="statEmergencyAvg">Highest revenue intent</div></div>
            <div class="stat-card"><div class="label">Money Keywords (Tier 1)</div><div class="value" id="statMoney">--</div><div class="sub" id="statMoneyAvg"></div></div>
            <div class="stat-card"><div class="label">Contract Keywords (Tier 2)</div><div class="value" id="statContract">--</div><div class="sub" id="statContractAvg"></div></div>
            <div class="stat-card"><div class="label">Est. Monthly Traffic Lost</div><div class="value" id="statLoss">--</div><div class="sub down" id="statLossSub">To competitors</div></div>
        </div>

        <!-- SECTION 2: SERVICE COVERAGE GAP MATRIX -->
        <div class="card" id="gapMatrixCard" style="display:none;">
            <h2>Service Coverage Gap Matrix</h2>
            <p class="card-desc">Do competitors have dedicated service pages you're missing? Each gap is a lost contract opportunity.</p>
            <div id="gapMatrixContainer"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Analyzing service coverage...</p></div></div>
        </div>

        <!-- SECTION 3: KEYWORD BATTLES -->
        <div class="card" id="keywordBattlesCard" style="display:none;">
            <h2>Keyword Battles - Revenue Intent</h2>
            <p class="card-desc">Keywords ranked by contract value, not vanity volume. Priority = (Intent x Impressions) - Position penalty.</p>
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('emergency')">Emergency</button>
                <button class="tab-btn" onclick="switchTab('money')">Money (Tier 1)</button>
                <button class="tab-btn" onclick="switchTab('contract')">Contract (Tier 2)</button>
                <button class="tab-btn" onclick="switchTab('trust')">Trust (Tier 3)</button>
                <button class="tab-btn" onclick="switchTab('almost')">Almost Winning</button>
                <button class="tab-btn" onclick="switchTab('big')">Big Opportunity</button>
            </div>
            <div id="tabEmergency" class="tab-content active"></div>
            <div id="tabMoney" class="tab-content"></div>
            <div id="tabContract" class="tab-content"></div>
            <div id="tabTrust" class="tab-content"></div>
            <div id="tabAlmost" class="tab-content"></div>
            <div id="tabBig" class="tab-content"></div>
        </div>

        <!-- SECTION 4: ON-PAGE SEO COMPARISON -->
        <div class="card" id="onPageCard" style="display:none;">
            <h2>On-Page SEO Head-to-Head</h2>
            <p class="card-desc">How does your homepage compare to competitors on key SEO signals?</p>
            <div id="onPageContainer"><div class="loading"><div class="spinner"></div></div></div>
        </div>

        <!-- SECTION 5: LOCAL PRESENCE -->
        <div class="card" id="localCard" style="display:none;">
            <h2>Local Presence Comparison</h2>
            <p class="card-desc">Directory listings and local SEO signals. For service businesses, this determines Map Pack ranking.</p>
            <div class="two-col" style="margin-bottom:25px;">
                <div>
                    <div id="localContainer"><div class="loading"><div class="spinner"></div></div></div>
                </div>
                <div>
                    <div style="background:#f8f9fa;border-radius:12px;overflow:hidden;border:2px solid #e9ecef;">
                        <iframe src="https://maps.google.com/maps?q=2216+Mansion+Cross+Ln,+Virginia+Beach,+VA+23456&t=&z=12&ie=UTF8&iwloc=&output=embed" width="100%" height="300" style="border:0;display:block;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                        <div style="padding:15px;">
                            <div style="display:flex;align-items:flex-start;gap:10px;">
                                <div style="width:36px;height:36px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.85rem;flex-shrink:0;">HQ</div>
                                <div>
                                    <div style="font-weight:700;font-size:0.95rem;color:#333;">Beach Hydrovac</div>
                                    <div style="font-size:0.82rem;color:#666;margin-top:2px;">2216 Mansion Cross Ln, Virginia Beach, VA 23456</div>
                                    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                                        <span style="display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.72rem;font-weight:600;background:#fff3cd;color:#856404;">Registration Pending</span>
                                        <a href="https://beachhydrovac.com/contact/" target="_blank" style="display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.72rem;font-weight:600;background:#cce5ff;color:#004085;text-decoration:none;">beachhydrovac.com</a>
                                    </div>
                                    <div style="margin-top:10px;font-size:0.78rem;color:#888;">Service Area: Virginia Beach, Norfolk, Chesapeake, Hampton Roads, VA &bull; NC &bull; MD &bull; DE</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 6: SPEED COMPARISON -->
        <div class="card" id="speedCard" style="display:none;">
            <h2>Core Web Vitals Comparison</h2>
            <p class="card-desc">Mobile performance scores from Google PageSpeed Insights API.</p>
            <div class="two-col">
                <div class="chart-container"><canvas id="speedChart"></canvas></div>
                <div id="speedScoreCards"></div>
            </div>
        </div>

        <!-- SECTION 7: ACTION PLAN -->
        <div class="card" id="actionCard" style="display:none;">
            <h2>Auto-Generated Action Plan</h2>
            <p class="card-desc">Prioritized recommendations based on competitive analysis. Focus on what wins contracts.</p>
            <div id="actionPlan"></div>
        </div>

    </div>

    <!-- ADD COMPETITOR MODAL -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h3>Add Competitor</h3>
            <label>Domain *</label>
            <input type="text" id="modalDomain" placeholder="e.g. competitor.com">
            <label>Display Name</label>
            <input type="text" id="modalName" placeholder="e.g. ABC Hydrovac">
            <label>Competitor Type</label>
            <select id="modalType">
                <option value="direct">Direct Competitor</option>
                <option value="traditional-excavation">Traditional Excavation</option>
                <option value="utility-contractor">Utility Contractor</option>
                <option value="general">General</option>
            </select>
            <label>Notes</label>
            <input type="text" id="modalNotes" placeholder="Optional notes...">
            <div class="modal-actions">
                <button class="btn btn-outline" style="color:#666; border-color:#ddd;" onclick="hideAddModal()">Cancel</button>
                <button class="btn btn-gradient" onclick="addCompetitor()">Add Competitor</button>
            </div>
        </div>
    </div>

    <script src="/sidebar.js"></script>
    <script>
        let clientConfig = {};
        let gscProperty = '';
        let competitors = [];
        let analysisData = {};
        let speedData = [];
        let keywordData = null;
        let gapData = {};
        let localData = [];
        let actionItems = [];
        let speedChartInstance = null;

        async function init() {
            initSidebar('/competitors');
            try {
                const cfgRes = await fetch('/api/config');
                clientConfig = await cfgRes.json();
                document.getElementById('headerSubtitle').textContent = `Competitive landscape for ${clientConfig.name || clientConfig.domain}`;
                await resolveGSC();
                await loadCompetitors();
            } catch(e) { console.error('Init error:', e); }
        }

        async function resolveGSC() {
            try {
                const res = await fetch('/api/gsc/sites');
                const data = await res.json();
                if (data.success && data.sites) {
                    const match = data.sites.find(s => s.siteUrl.toLowerCase().includes(clientConfig.domain.toLowerCase()));
                    gscProperty = match ? match.siteUrl : 'https://' + clientConfig.domain + '/';
                } else { gscProperty = 'https://' + clientConfig.domain + '/'; }
            } catch(e) { gscProperty = 'https://' + clientConfig.domain + '/'; }
        }

        // --- Competitor Management ---
        async function loadCompetitors() {
            const res = await fetch('/api/competitors');
            const data = await res.json();
            competitors = data.competitors || [];
            renderCompCards();
            if (competitors.length > 0) loadAllAnalysis();
        }

        function renderCompCards() {
            const grid = document.getElementById('compGrid');
            if (competitors.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><h3>No competitors tracked yet</h3><p>Add 2-3 competitors to unlock competitive intelligence</p><button class="btn btn-gradient" style="margin-top:15px;" onclick="showAddModal()">+ Add Your First Competitor</button></div>`;
                return;
            }
            grid.innerHTML = competitors.map(c => {
                const typeClass = 'type-' + (c.type || 'general');
                const typeLabel = { 'direct': 'Direct', 'traditional-excavation': 'Excavation', 'utility-contractor': 'Utility', 'general': 'General' }[c.type] || 'General';
                return `<div class="comp-card">
                    <button class="comp-remove" onclick="removeCompetitor('${c.domain}')" title="Remove">&times;</button>
                    <div class="comp-domain">${c.domain}</div>
                    <div class="comp-name">${c.name || ''} <span class="type-badge ${typeClass}">${typeLabel}</span></div>
                    ${c.last_crawl ? `<div style="font-size:0.78rem;color:#aaa;">Last analyzed: ${new Date(c.last_crawl).toLocaleDateString()}</div>` : ''}
                    <div class="comp-actions">
                        <button class="btn btn-sm btn-gradient" onclick="analyzeSingle('${c.domain}')">Analyze</button>
                    </div>
                </div>`;
            }).join('');
        }

        function showAddModal() { document.getElementById('addModal').classList.add('show'); document.getElementById('modalDomain').focus(); }
        function hideAddModal() { document.getElementById('addModal').classList.remove('show'); }

        async function addCompetitor() {
            const domain = document.getElementById('modalDomain').value.trim();
            if (!domain) return alert('Domain is required');
            const body = {
                domain,
                name: document.getElementById('modalName').value.trim(),
                type: document.getElementById('modalType').value,
                notes: document.getElementById('modalNotes').value.trim()
            };
            const res = await fetch('/api/competitors', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const data = await res.json();
            if (!data.success) return alert(data.error || 'Failed to add');
            hideAddModal();
            document.getElementById('modalDomain').value = '';
            document.getElementById('modalName').value = '';
            document.getElementById('modalNotes').value = '';
            await loadCompetitors();
        }

        async function removeCompetitor(domain) {
            if (!confirm(`Remove ${domain}?`)) return;
            await fetch(`/api/competitors/${encodeURIComponent(domain)}`, { method: 'DELETE' });
            await loadCompetitors();
        }

        // --- Load All Analysis (parallel) ---
        async function loadAllAnalysis() {
            const sections = ['gapMatrixCard','keywordBattlesCard','onPageCard','localCard','speedCard','actionCard','tierStats'];
            sections.forEach(id => document.getElementById(id).style.display = '');

            await Promise.allSettled([
                loadKeywordBattles(),
                loadSpeedComparison(),
                loadLocalComparison(),
                ...competitors.map(c => loadCrawlAnalysis(c.domain))
            ]);

            renderOnPageComparison();
            buildActionPlan();
        }

        async function analyzeAll() {
            const btn = document.getElementById('analyzeAllBtn');
            btn.textContent = 'Analyzing...';
            btn.disabled = true;
            // Clear caches by re-fetching
            await loadAllAnalysis();
            btn.textContent = 'Analyze All';
            btn.disabled = false;
        }

        async function analyzeSingle(domain) {
            await loadCrawlAnalysis(domain);
            renderOnPageComparison();
            buildActionPlan();
        }

        // --- Crawl Analysis ---
        async function loadCrawlAnalysis(domain) {
            try {
                const res = await fetch(`/api/competitors/analyze?domain=${encodeURIComponent(domain)}`);
                const data = await res.json();
                if (data.success) analysisData[domain] = data.analysis;
            } catch(e) { console.error('Crawl error:', domain, e); }
        }

        // Also crawl own site
        async function loadOwnAnalysis() {
            if (analysisData[clientConfig.domain]) return;
            await loadCrawlAnalysis(clientConfig.domain);
        }

        // --- Keyword Battles ---
        async function loadKeywordBattles() {
            try {
                const res = await fetch(`/api/competitors/keyword-battles?site=${encodeURIComponent(gscProperty)}`);
                keywordData = await res.json();
                if (keywordData.success) renderKeywordBattles();
            } catch(e) { console.error('Keywords error:', e); }
        }

        function renderKeywordBattles() {
            if (!keywordData || !keywordData.success) return;

            const ts = keywordData.tierSummary;
            document.getElementById('statEmergency').textContent = ts.emergency?.count || 0;
            document.getElementById('statEmergencyAvg').textContent = ts.emergency?.count ? `Avg pos: ${ts.emergency.avgPosition}` : 'None found yet';
            document.getElementById('statEmergencyAvg').className = 'sub ' + (ts.emergency?.count > 0 ? 'up' : '');
            document.getElementById('statMoney').textContent = ts.money?.count || 0;
            document.getElementById('statMoneyAvg').textContent = ts.money?.count ? `Avg pos: ${ts.money.avgPosition}` : '';
            document.getElementById('statMoneyAvg').className = 'sub ' + (ts.money?.avgPosition <= 10 ? 'up' : 'down');
            document.getElementById('statContract').textContent = ts.contract?.count || 0;
            document.getElementById('statContractAvg').textContent = ts.contract?.count ? `Avg pos: ${ts.contract.avgPosition}` : '';

            const totalLoss = (ts.emergency?.totalTrafficLoss || 0) + (ts.money?.totalTrafficLoss || 0) + (ts.contract?.totalTrafficLoss || 0) + (ts.trust?.totalTrafficLoss || 0);
            document.getElementById('statLoss').textContent = totalLoss.toLocaleString();
            document.getElementById('statLossSub').textContent = `Est. clicks/month lost to competitors`;

            // Render tier tabs
            renderKwTable('tabEmergency', ts.emergency?.topKeywords || [], 'emergency');
            renderKwTable('tabMoney', ts.money?.topKeywords || [], 'money');
            renderKwTable('tabContract', ts.contract?.topKeywords || [], 'contract');
            renderKwTable('tabTrust', ts.trust?.topKeywords || [], 'trust');
            renderKwTable('tabAlmost', keywordData.almostWinning || [], 'position');
            renderKwTable('tabBig', keywordData.bigOpportunity || [], 'position');
        }

        function renderKwTable(containerId, keywords, mode) {
            const el = document.getElementById(containerId);
            if (!keywords.length) { el.innerHTML = '<p style="color:#888;padding:20px;">No keywords in this category yet.</p>'; return; }

            const rows = keywords.map(k => {
                const tierBadge = k.tier === 'emergency' ? '<span class="tier-badge tier-emergency">URGENT</span>'
                    : k.tier === 'money' ? '<span class="tier-badge tier-money">$$</span>'
                    : k.tier === 'contract' ? '<span class="tier-badge tier-contract">B2B</span>'
                    : k.tier === 'trust' ? '<span class="tier-badge tier-trust">EDU</span>' : '';

                // Vibe tags
                const vibeHtml = (k.vibeTags || []).map(t => {
                    const cls = t === 'Target This' ? 'vibe-target' : t === 'Ignore' ? 'vibe-ignore' : t === 'Local Priority' ? 'vibe-local' : t === 'Almost There' ? 'vibe-almost' : t === 'Urgent Revenue' ? 'vibe-urgent' : '';
                    return `<span class="vibe-tag ${cls}">${t}</span>`;
                }).join('');

                // SERP features
                const serpHtml = (k.serpFeatures || []).map(f => {
                    const cls = f === 'Map Pack' ? 'serp-map' : f === 'Local Ads' ? 'serp-ads' : f === 'Featured Snippet' ? 'serp-snippet' : '';
                    return `<span class="serp-feature ${cls}">${f}</span>`;
                }).join('');

                // Win-ability bar
                const w = k.winability || 50;
                const winCls = w >= 65 ? 'win-high' : w >= 40 ? 'win-mid' : 'win-low';
                const winHtml = `<span class="win-bar ${winCls}"><span class="win-bar-track"><span class="win-bar-fill" style="width:${w}%"></span></span>${w}</span>`;

                return `<tr>
                    <td><strong>${k.keyword}</strong> ${tierBadge}${vibeHtml}<br>${serpHtml}</td>
                    <td>${posBadge(k.position)}</td>
                    <td>${k.impressions.toLocaleString()}</td>
                    <td>${k.clicks.toLocaleString()}</td>
                    <td style="font-weight:600;">${Math.round(k.priority).toLocaleString()}</td>
                    <td>${winHtml}</td>
                    <td style="color:#dc3545;font-weight:600;">${k.trafficLoss > 0 ? '-' + k.trafficLoss : '0'}</td>
                </tr>`;
            }).join('');

            el.innerHTML = `<table><thead><tr><th>Keyword</th><th>Position</th><th>Impr.</th><th>Clicks</th><th>Priority</th><th>Win-ability</th><th>Traffic Lost</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function posBadge(pos) {
            if (pos <= 3) return `<span class="pos-badge pos-top3">#${pos.toFixed(1)}</span>`;
            if (pos <= 10) return `<span class="pos-badge pos-top10">#${pos.toFixed(1)}</span>`;
            if (pos <= 20) return `<span class="pos-badge pos-top20">#${pos.toFixed(1)}</span>`;
            return `<span class="pos-badge pos-low">#${pos.toFixed(1)}</span>`;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabMap = { emergency: 'tabEmergency', money: 'tabMoney', contract: 'tabContract', trust: 'tabTrust', almost: 'tabAlmost', big: 'tabBig' };
            document.getElementById(tabMap[tab]).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Content Gap Matrix ---
        async function loadContentGap(domain) {
            try {
                const res = await fetch(`/api/competitors/content-gap?domain=${encodeURIComponent(domain)}`);
                const data = await res.json();
                if (data.success) { gapData[domain] = data.gap; renderGapMatrix(); }
            } catch(e) { console.error('Gap error:', e); }
        }

        function renderGapMatrix() {
            const container = document.getElementById('gapMatrixContainer');
            // Use first competitor's gap data, or merge if multiple
            const domains = Object.keys(gapData);
            if (domains.length === 0) { container.innerHTML = '<p style="color:#888;padding:20px;">Add competitors and run analysis to see service coverage gaps.</p>'; return; }

            const allServices = new Map();
            domains.forEach(d => {
                const matrix = gapData[d].gapMatrix || [];
                matrix.forEach(row => {
                    if (!allServices.has(row.service)) allServices.set(row.service, { you: row.you, competitors: {} });
                    allServices.get(row.service).competitors[d] = row.competitor;
                    if (row.you) allServices.get(row.service).you = true;
                });
            });

            const compHeaders = domains.map(d => `<th>${d}</th>`).join('');
            const rows = [...allServices.entries()].map(([service, data]) => {
                const yourCell = data.you ? '<td class="coverage-yes">&#10003; Has page</td>' : '<td class="coverage-no">&#10007; No page</td>';
                const compCells = domains.map(d => {
                    const has = data.competitors[d];
                    const isGap = has && !data.you;
                    return has
                        ? `<td class="coverage-yes">&#10003; Has page${isGap ? ' <span class="gap-badge">GAP</span>' : ''}</td>`
                        : '<td class="coverage-no">&#10007;</td>';
                }).join('');
                return `<tr><td><strong>${service}</strong></td>${yourCell}${compCells}</tr>`;
            }).join('');

            container.innerHTML = `<table class="gap-matrix"><thead><tr><th>Service Type</th><th>Your Site</th>${compHeaders}</tr></thead><tbody>${rows}</tbody></table>`;

            // Add gap alerts
            const gaps = [...allServices.entries()].filter(([, data]) => !data.you && Object.values(data.competitors).some(v => v));
            if (gaps.length > 0) {
                const gapList = gaps.map(([svc]) => `<li style="padding:4px 0;">Create a dedicated <strong>${svc}</strong> service page</li>`).join('');
                container.innerHTML += `<div style="margin-top:18px;padding:15px;background:#fff3cd;border-radius:10px;border-left:4px solid #ffc107;"><strong style="color:#856404;">Service Page Gaps Found:</strong><ul style="margin-top:8px;padding-left:20px;color:#856404;">${gapList}</ul></div>`;
            }
        }

        // --- On-Page SEO Comparison ---
        function renderOnPageComparison() {
            const container = document.getElementById('onPageContainer');
            const ownDomain = clientConfig.domain;
            const ownData = analysisData[ownDomain];
            const compDomains = competitors.map(c => c.domain).filter(d => analysisData[d]);

            if (!ownData && compDomains.length === 0) { container.innerHTML = '<p style="color:#888;padding:20px;">Analysis results will appear here after crawling.</p>'; return; }

            const metrics = [
                { label: 'Title Length', key: 'titleLength', ideal: [50, 60], unit: 'chars' },
                { label: 'Meta Desc Length', key: 'metaDescLength', ideal: [150, 160], unit: 'chars' },
                { label: 'H1 Count', key: 'h1Count', ideal: [1, 1], unit: '' },
                { label: 'Word Count', key: 'wordCount', ideal: [800, null], unit: 'words' },
                { label: 'Total Headings', key: 'totalHeadings', ideal: [5, null], unit: '' },
                { label: 'Image Alt Coverage', key: 'imageAltCoverage', ideal: [90, null], unit: '%' },
                { label: 'Internal Links', key: 'internalLinks', ideal: [10, null], unit: '' },
                { label: 'Schema Types', key: 'schemaTypes', isArray: true },
                { label: 'LocalBusiness Schema', key: 'hasLocalBusiness', isBool: true }
            ];

            const compHeaders = compDomains.map(d => `<th>${d}</th>`).join('');
            const rows = metrics.map(m => {
                const ownVal = ownData ? (m.isArray ? (ownData.homepage[m.key] || []).join(', ') || 'None' : m.isBool ? (ownData.homepage[m.key] ? 'Yes' : 'No') : ownData.homepage[m.key]) : '--';
                const compCells = compDomains.map(d => {
                    const cd = analysisData[d];
                    const val = cd ? (m.isArray ? (cd.homepage[m.key] || []).join(', ') || 'None' : m.isBool ? (cd.homepage[m.key] ? 'Yes' : 'No') : cd.homepage[m.key]) : '--';
                    // Color code: compare
                    let cls = '';
                    if (!m.isArray && !m.isBool && ownData && cd) {
                        const ov = ownData.homepage[m.key]; const cv = cd.homepage[m.key];
                        if (typeof ov === 'number' && typeof cv === 'number') cls = ov >= cv ? 'cell-lose' : 'cell-win';
                    }
                    if (m.isBool && ownData && cd) cls = cd.homepage[m.key] && !ownData.homepage[m.key] ? 'cell-win' : '';
                    return `<td class="${cls}">${val}${m.unit && typeof val === 'number' ? ' ' + m.unit : ''}</td>`;
                }).join('');

                const ownCls = '';
                return `<tr><td><strong>${m.label}</strong></td><td class="${ownCls}">${ownVal}${m.unit && typeof ownVal === 'number' ? ' ' + m.unit : ''}</td>${compCells}</tr>`;
            }).join('');

            container.innerHTML = `<table><thead><tr><th>Metric</th><th>${ownDomain || 'Your Site'}</th>${compHeaders}</tr></thead><tbody>${rows}</tbody></table>`;

            // Tech comparison
            const techRows = compDomains.map(d => {
                const cd = analysisData[d];
                return cd ? `<tr><td>${d}</td><td>${cd.technology?.cms || 'Unknown'}</td><td>${(cd.technology?.analytics || []).join(', ') || 'None'}</td><td>${cd.servicePages?.length || 0} found</td></tr>` : '';
            }).join('');

            if (techRows) {
                container.innerHTML += `<h3 style="margin-top:25px;font-size:1rem;color:#333;">Technology & Service Pages</h3>
                <table style="margin-top:10px;"><thead><tr><th>Domain</th><th>CMS</th><th>Analytics</th><th>Service Pages</th></tr></thead><tbody>
                ${ownData ? `<tr><td>${ownDomain}</td><td>${ownData.technology?.cms || 'Unknown'}</td><td>${(ownData.technology?.analytics || []).join(', ') || 'None'}</td><td>${ownData.servicePages?.length || 0} found</td></tr>` : ''}
                ${techRows}</tbody></table>`;
            }
        }

        // --- Local Presence ---
        async function loadLocalComparison() {
            try {
                const res = await fetch('/api/competitors/local-compare');
                const data = await res.json();
                if (data.success) { localData = data.results; renderLocalComparison(); }
            } catch(e) { console.error('Local error:', e); }
        }

        function renderLocalComparison() {
            const container = document.getElementById('localContainer');
            if (!localData.length) { container.innerHTML = '<p style="color:#888;padding:20px;">No local data available.</p>'; return; }

            // Score comparison
            const scoreCards = localData.map(d => {
                const scoreColor = d.localScore >= 60 ? '#28a745' : d.localScore >= 30 ? '#ffc107' : '#dc3545';
                return `<div style="text-align:center;"><div style="font-size:2rem;font-weight:700;color:${scoreColor};">${d.localScore}</div><div style="font-size:0.82rem;color:#666;">${d.domain}</div></div>`;
            }).join('');

            // Directory listing comparison
            const directories = localData[0]?.directories?.map(d => d.directory) || [];
            const dirHeaders = localData.map(d => `<th>${d.domain}</th>`).join('');
            const dirRows = directories.map(dir => {
                const cells = localData.map(site => {
                    const entry = site.directories?.find(d => d.directory === dir);
                    return entry?.listed ? '<td class="coverage-yes">&#10003; Listed</td>' : '<td class="coverage-no">&#10007;</td>';
                }).join('');
                return `<tr><td><strong>${dir}</strong></td>${cells}</tr>`;
            }).join('');

            // Signals comparison
            const sigHeaders = localData.map(d => `<th>${d.domain}</th>`).join('');
            const signalKeys = [
                { key: 'hasSchema', label: 'Schema Markup' },
                { key: 'hasLocalBusiness', label: 'LocalBusiness Schema' },
                { key: 'hasAddress', label: 'Address on Site' },
                { key: 'hasPhone', label: 'Phone Link' }
            ];
            const sigRows = signalKeys.map(s => {
                const cells = localData.map(site => {
                    const val = site.signals?.[s.key];
                    return val ? '<td class="coverage-yes">&#10003;</td>' : '<td class="coverage-no">&#10007;</td>';
                }).join('');
                return `<tr><td><strong>${s.label}</strong></td>${cells}</tr>`;
            }).join('');

            container.innerHTML = `
                <div style="display:flex;gap:30px;justify-content:center;margin-bottom:25px;padding:15px;background:#f8f9fa;border-radius:10px;">
                    <div style="font-size:0.85rem;font-weight:600;color:#888;align-self:center;">Local Score:</div>
                    ${scoreCards}
                </div>
                <h3 style="font-size:0.95rem;color:#333;margin-bottom:10px;">Directory Listings</h3>
                <table><thead><tr><th>Directory</th>${dirHeaders}</tr></thead><tbody>${dirRows}</tbody></table>
                <h3 style="font-size:0.95rem;color:#333;margin:20px 0 10px;">Website Signals</h3>
                <table><thead><tr><th>Signal</th>${sigHeaders}</tr></thead><tbody>${sigRows}</tbody></table>`;
        }

        // --- Speed Comparison ---
        async function loadSpeedComparison() {
            try {
                const res = await fetch('/api/competitors/speed-compare');
                const data = await res.json();
                if (data.success) { speedData = data.results; renderSpeedComparison(); }
            } catch(e) { console.error('Speed error:', e); }
        }

        function renderSpeedComparison() {
            if (!speedData.length) return;

            const colors = ['#667eea', '#28a745', '#ffc107', '#dc3545', '#17a2b8'];

            // Radar chart
            const labels = ['Performance', 'FCP', 'LCP', 'CLS', 'TBT'];
            const datasets = speedData.filter(d => !d.error).map((d, i) => ({
                label: d.domain,
                data: [
                    d.performanceScore,
                    d.vitals?.FCP?.score ? d.vitals.FCP.score * 100 : 0,
                    d.vitals?.LCP?.score ? d.vitals.LCP.score * 100 : 0,
                    d.vitals?.CLS?.score ? d.vitals.CLS.score * 100 : 0,
                    d.vitals?.TBT?.score ? d.vitals.TBT.score * 100 : 0
                ],
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '22',
                borderWidth: 2,
                pointRadius: 4
            }));

            if (speedChartInstance) speedChartInstance.destroy();
            speedChartInstance = new Chart(document.getElementById('speedChart'), {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 100, ticks: { stepSize: 25 } } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Score cards
            const cardsEl = document.getElementById('speedScoreCards');
            const vitals = ['FCP', 'LCP', 'CLS', 'TBT', 'SI'];
            const thresholds = { FCP: [1800, 3000], LCP: [2500, 4000], CLS: [0.1, 0.25], TBT: [200, 600], SI: [3400, 5800] };

            let cardsHtml = '<div class="speed-grid">';
            for (const v of vitals) {
                const vals = speedData.filter(d => d.vitals?.[v]).map(d => ({
                    domain: d.domain,
                    value: d.vitals[v].value,
                    display: d.vitals[v].displayValue
                }));
                if (!vals.length) continue;
                const best = vals.reduce((a, b) => (v === 'CLS' ? (a.value < b.value ? a : b) : (a.value < b.value ? a : b)));
                const t = thresholds[v] || [0, Infinity];
                const cls = best.value <= t[0] ? 'good' : best.value <= t[1] ? 'mid' : 'poor';
                cardsHtml += `<div class="speed-card ${cls}"><div class="vital-name">${v}</div><div class="vital-value">${best.display || best.value}</div><div style="font-size:0.75rem;color:#888;margin-top:4px;">${best.domain}</div></div>`;
            }
            cardsHtml += '</div>';

            // Performance scores
            cardsHtml += '<div style="margin-top:20px;">';
            speedData.forEach((d, i) => {
                const pct = d.performanceScore;
                const color = pct >= 90 ? '#28a745' : pct >= 50 ? '#ffc107' : '#dc3545';
                cardsHtml += `<div style="display:flex;align-items:center;gap:12px;padding:8px 0;"><span style="font-size:0.85rem;color:#666;min-width:140px;">${d.domain}</span><div style="flex:1;height:8px;background:#e9ecef;border-radius:4px;"><div style="width:${pct}%;height:100%;background:${color};border-radius:4px;"></div></div><span style="font-weight:700;color:${color};">${pct}</span></div>`;
            });
            cardsHtml += '</div>';

            cardsEl.innerHTML = cardsHtml;
        }

        // --- Action Plan Generator ---
        function buildActionPlan() {
            actionItems = [];
            const el = document.getElementById('actionPlan');

            // Check gap matrix
            for (const domain of Object.keys(gapData)) {
                const matrix = gapData[domain].gapMatrix || [];
                matrix.filter(r => r.gap).forEach(r => {
                    actionItems.push({ priority: 'critical', text: `Create a dedicated <strong>${r.service}</strong> page — competitor ${domain} has one and you don't. Each missing service page is a lost contract opportunity.`, impact: 'High' });
                });
            }

            // Check keyword battles
            if (keywordData?.success) {
                const topMoney = (keywordData.tierSummary?.money?.topKeywords || []).filter(k => k.position >= 4 && k.position <= 10).slice(0, 3);
                topMoney.forEach(k => {
                    actionItems.push({ priority: 'high', text: `You rank <strong>#${k.position.toFixed(1)}</strong> for "<strong>${k.keyword}</strong>" — this is a Tier 1 money keyword. Optimize this page to break into top 3 and capture ~${k.trafficLoss} more clicks/month.`, impact: 'High' });
                });

                const bigOp = (keywordData.bigOpportunity || []).filter(k => k.tier === 'money').slice(0, 2);
                bigOp.forEach(k => {
                    actionItems.push({ priority: 'high', text: `Money keyword "<strong>${k.keyword}</strong>" is at position #${k.position.toFixed(1)} (page 2). Create or optimize content targeting this term to reach page 1.`, impact: 'Medium' });
                });
            }

            // Check local presence
            if (localData.length > 1) {
                const own = localData[0];
                const compBetter = localData.slice(1).filter(c => c.localScore > own.localScore);
                if (compBetter.length > 0) {
                    actionItems.push({ priority: 'high', text: `Your local score (${own.localScore}) is lower than ${compBetter.map(c => c.domain + ' (' + c.localScore + ')').join(', ')}. Improve directory listings and add LocalBusiness schema.`, impact: 'High' });
                }
                if (own.signals && !own.signals.hasLocalBusiness) {
                    actionItems.push({ priority: 'critical', text: `Add <strong>LocalBusiness schema markup</strong> to your website. This is critical for Map Pack ranking and competitors already have it.`, impact: 'High' });
                }
            }

            // Check speed
            if (speedData.length > 1) {
                const own = speedData[0];
                const faster = speedData.slice(1).filter(c => c.performanceScore > own.performanceScore + 15);
                if (faster.length > 0) {
                    actionItems.push({ priority: 'opportunity', text: `Your mobile performance score (${own.performanceScore}) is significantly lower than ${faster.map(c => c.domain + ' (' + c.performanceScore + ')').join(', ')}. Improve page speed for better rankings.`, impact: 'Medium' });
                }
            }

            // Check on-page analysis
            const ownAnalysis = analysisData[clientConfig.domain];
            if (ownAnalysis && !ownAnalysis.homepage.hasLocalBusiness) {
                // Already covered above
            }
            if (ownAnalysis && ownAnalysis.homepage.imageAltCoverage < 80) {
                actionItems.push({ priority: 'opportunity', text: `Image alt text coverage is only <strong>${ownAnalysis.homepage.imageAltCoverage}%</strong>. Add descriptive alt text with service keywords to boost image SEO.`, impact: 'Low' });
            }

            if (actionItems.length === 0) {
                el.innerHTML = '<p style="color:#888;padding:20px;">Run full analysis to generate action items. Add competitors and click "Analyze All".</p>';
                return;
            }

            // Sort: critical first, then high, then opportunity
            const order = { critical: 0, high: 1, opportunity: 2 };
            actionItems.sort((a, b) => (order[a.priority] || 3) - (order[b.priority] || 3));

            el.innerHTML = actionItems.map(a => `
                <div class="action-item">
                    <span class="action-priority priority-${a.priority}">${a.priority === 'critical' ? 'CRITICAL' : a.priority === 'high' ? 'HIGH' : 'OPPORTUNITY'}</span>
                    <div><div class="action-text">${a.text}</div><div class="action-impact">Impact: ${a.impact}</div></div>
                </div>
            `).join('');
        }

        // --- Init: Load content gap for each competitor after analysis ---
        const origLoadAll = loadAllAnalysis;
        loadAllAnalysis = async function() {
            const sections = ['gapMatrixCard','keywordBattlesCard','onPageCard','localCard','speedCard','actionCard','tierStats'];
            sections.forEach(id => document.getElementById(id).style.display = '');

            // Load own site analysis too
            await loadCrawlAnalysis(clientConfig.domain);

            await Promise.allSettled([
                loadKeywordBattles(),
                loadSpeedComparison(),
                loadLocalComparison(),
                ...competitors.map(c => loadCrawlAnalysis(c.domain)),
                ...competitors.map(c => loadContentGap(c.domain))
            ]);

            renderOnPageComparison();
            renderGapMatrix();
            buildActionPlan();
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>
