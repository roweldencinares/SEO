<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitive Intelligence - SEO Dashboard</title>
    <link rel="stylesheet" href="/sidebar.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        header { background: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h1 { color: #333; font-size: 1.8rem; margin-bottom: 5px; font-weight: 700; }
        .subtitle { color: #666; font-size: 0.95rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .label { color: #888; font-size: 0.85rem; margin-bottom: 8px; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: #333; }
        .stat-card .change { font-size: 0.85rem; margin-top: 5px; }
        .stat-card .change.up { color: #28a745; }
        .stat-card .change.down { color: #dc3545; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h2 { font-size: 1.2rem; color: #333; margin-bottom: 15px; }
        .chart-container { position: relative; height: 300px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; background: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; border-bottom: 2px solid #e9ecef; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; color: #333; }
        tr:hover { background: #f8f9fa; }
        .pos-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .pos-top3 { background: #d4edda; color: #155724; }
        .pos-top10 { background: #cce5ff; color: #004085; }
        .pos-top20 { background: #fff3cd; color: #856404; }
        .pos-low { background: #f8d7da; color: #721c24; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Competitive Intelligence</h1>
            <p class="subtitle" id="headerSubtitle">Analyze your competitive landscape and keyword positioning</p>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="label">Your Keywords</div><div class="value" id="totalKeywords">--</div><div class="change" id="keywordsChange">Loading...</div></div>
            <div class="stat-card"><div class="label">Top 3 Positions</div><div class="value" id="top3Count">--</div><div class="change up" id="top3Change"></div></div>
            <div class="stat-card"><div class="label">Top 10 Positions</div><div class="value" id="top10Count">--</div><div class="change up" id="top10Change"></div></div>
            <div class="stat-card"><div class="label">Avg. Position</div><div class="value" id="avgPosition">--</div><div class="change" id="posChange"></div></div>
        </div>

        <div class="two-col">
            <div class="card">
                <h2>Position Distribution</h2>
                <div class="chart-container"><canvas id="positionChart"></canvas></div>
            </div>
            <div class="card">
                <h2>Keyword Movement (7 Days)</h2>
                <div class="chart-container"><canvas id="movementChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h2>Keyword Gap Analysis - High Impression, Low Position</h2>
            <p style="color:#888; font-size:0.85rem; margin-bottom:15px;">Keywords with high visibility but low rankings - biggest opportunities to gain traffic</p>
            <div id="gapTableContainer"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Analyzing keyword gaps...</p></div></div>
        </div>

        <div class="card">
            <h2>Top Performing Keywords</h2>
            <div id="topKeywordsContainer"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Loading keyword data...</p></div></div>
        </div>

        <div class="card">
            <h2>Rising Keywords (Improving Positions)</h2>
            <div id="risingContainer"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Loading trends...</p></div></div>
        </div>
    </div>

    <script src="/sidebar.js"></script>
    <script>
        let clientConfig = {};
        let gscProperty = '';

        async function init() {
            initSidebar('/competitors');
            try {
                const cfgRes = await fetch('/api/config');
                clientConfig = await cfgRes.json();
                document.getElementById('headerSubtitle').textContent = `Competitive landscape for ${clientConfig.name || clientConfig.domain}`;
                await resolveGSC();
                loadAllData();
            } catch(e) { console.error('Init error:', e); }
        }

        async function resolveGSC() {
            try {
                const res = await fetch('/api/gsc/sites');
                const data = await res.json();
                if (data.success && data.sites) {
                    const match = data.sites.find(s => s.siteUrl.toLowerCase().includes(clientConfig.domain.toLowerCase()));
                    gscProperty = match ? match.siteUrl : 'https://' + clientConfig.domain + '/';
                } else {
                    gscProperty = 'https://' + clientConfig.domain + '/';
                }
            } catch(e) { gscProperty = 'https://' + clientConfig.domain + '/'; }
        }

        async function loadAllData() {
            try {
                const [rankingsRes, summaryRes] = await Promise.all([
                    fetch(`/api/gsc/rankings?site=${encodeURIComponent(gscProperty)}`),
                    fetch(`/api/gsc/summary?site=${encodeURIComponent(gscProperty)}`)
                ]);
                const rankings = await rankingsRes.json();
                const summary = await summaryRes.json();

                if (summary.success && summary.summary) {
                    document.getElementById('totalKeywords').textContent = summary.summary.keywordsTracked.toLocaleString();
                    document.getElementById('top10Count').textContent = summary.summary.top10Rankings.toLocaleString();
                    document.getElementById('avgPosition').textContent = summary.summary.avgPosition;
                    document.getElementById('keywordsChange').textContent = `Tracked in last 30 days`;
                    document.getElementById('posChange').textContent = summary.summary.avgPosition <= 20 ? 'Good positioning' : 'Room to improve';
                    document.getElementById('posChange').className = 'change ' + (summary.summary.avgPosition <= 20 ? 'up' : 'down');
                }

                if (rankings.success && rankings.rankings) {
                    const kws = rankings.rankings;
                    const top3 = kws.filter(k => k.position <= 3).length;
                    document.getElementById('top3Count').textContent = top3.toLocaleString();
                    document.getElementById('top3Change').textContent = `${((top3/kws.length)*100).toFixed(1)}% of total`;

                    renderPositionChart(kws);
                    renderMovementChart(kws);
                    renderGapTable(kws);
                    renderTopKeywords(kws);
                    renderRisingKeywords(kws);
                }
            } catch(e) {
                console.error('Data load error:', e);
                document.querySelectorAll('.loading').forEach(el => el.innerHTML = '<p style="color:#dc3545;">Failed to load data. Check GSC connection.</p>');
            }
        }

        function renderPositionChart(kws) {
            const buckets = { '1-3': 0, '4-10': 0, '11-20': 0, '21-50': 0, '50+': 0 };
            kws.forEach(k => {
                const p = k.position;
                if (p <= 3) buckets['1-3']++;
                else if (p <= 10) buckets['4-10']++;
                else if (p <= 20) buckets['11-20']++;
                else if (p <= 50) buckets['21-50']++;
                else buckets['50+']++;
            });
            new Chart(document.getElementById('positionChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(buckets),
                    datasets: [{ data: Object.values(buckets), backgroundColor: ['#28a745','#17a2b8','#ffc107','#fd7e14','#dc3545'], borderWidth: 2, borderColor: '#fff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderMovementChart(kws) {
            const improved = kws.filter(k => k.trend === 'up').length;
            const declined = kws.filter(k => k.trend === 'down').length;
            const stable = kws.filter(k => k.trend === 'stable').length;
            new Chart(document.getElementById('movementChart'), {
                type: 'bar',
                data: {
                    labels: ['Improved', 'Stable', 'Declined'],
                    datasets: [{ data: [improved, stable, declined], backgroundColor: ['#28a745','#6c757d','#dc3545'], borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function posBadge(pos) {
            if (pos <= 3) return `<span class="pos-badge pos-top3">#${pos.toFixed(1)}</span>`;
            if (pos <= 10) return `<span class="pos-badge pos-top10">#${pos.toFixed(1)}</span>`;
            if (pos <= 20) return `<span class="pos-badge pos-top20">#${pos.toFixed(1)}</span>`;
            return `<span class="pos-badge pos-low">#${pos.toFixed(1)}</span>`;
        }

        function renderGapTable(kws) {
            const gaps = kws.filter(k => k.impressions >= 50 && k.position > 10).sort((a,b) => b.impressions - a.impressions).slice(0, 15);
            const container = document.getElementById('gapTableContainer');
            if (!gaps.length) { container.innerHTML = '<p style="color:#888; padding:20px;">No significant keyword gaps found - great job!</p>'; return; }
            container.innerHTML = `<table><thead><tr><th>Keyword</th><th>Position</th><th>Impressions</th><th>Clicks</th><th>Potential</th></tr></thead><tbody>${
                gaps.map(k => `<tr><td><strong>${k.keyword}</strong></td><td>${posBadge(k.position)}</td><td>${k.impressions.toLocaleString()}</td><td>${k.clicks.toLocaleString()}</td><td style="color:#28a745;font-weight:600;">High</td></tr>`).join('')
            }</tbody></table>`;
        }

        function renderTopKeywords(kws) {
            const top = kws.filter(k => k.clicks > 0).sort((a,b) => b.clicks - a.clicks).slice(0, 20);
            const container = document.getElementById('topKeywordsContainer');
            if (!top.length) { container.innerHTML = '<p style="color:#888; padding:20px;">No keyword data available yet.</p>'; return; }
            container.innerHTML = `<table><thead><tr><th>Keyword</th><th>Position</th><th>Clicks</th><th>Impressions</th><th>CTR</th><th>Trend</th></tr></thead><tbody>${
                top.map(k => {
                    const trend = k.trend === 'up' ? '<span style="color:#28a745;">&#9650;</span>' : k.trend === 'down' ? '<span style="color:#dc3545;">&#9660;</span>' : '<span style="color:#6c757d;">&#8212;</span>';
                    return `<tr><td><strong>${k.keyword}</strong></td><td>${posBadge(k.position)}</td><td>${k.clicks.toLocaleString()}</td><td>${k.impressions.toLocaleString()}</td><td>${(k.ctr * 100).toFixed(1)}%</td><td>${trend} ${k.positionChange > 0 ? '+' + k.positionChange.toFixed(1) : k.positionChange.toFixed(1)}</td></tr>`;
                }).join('')
            }</tbody></table>`;
        }

        function renderRisingKeywords(kws) {
            const rising = kws.filter(k => k.positionChange > 1).sort((a,b) => b.positionChange - a.positionChange).slice(0, 15);
            const container = document.getElementById('risingContainer');
            if (!rising.length) { container.innerHTML = '<p style="color:#888; padding:20px;">No significant position improvements this week.</p>'; return; }
            container.innerHTML = `<table><thead><tr><th>Keyword</th><th>Position</th><th>Improvement</th><th>Clicks</th><th>Impressions</th></tr></thead><tbody>${
                rising.map(k => `<tr><td><strong>${k.keyword}</strong></td><td>${posBadge(k.position)}</td><td style="color:#28a745;font-weight:600;">&#9650; +${k.positionChange.toFixed(1)}</td><td>${k.clicks.toLocaleString()}</td><td>${k.impressions.toLocaleString()}</td></tr>`).join('')
            }</tbody></table>`;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
